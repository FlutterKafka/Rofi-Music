#!/bin/bash
export LC_ALL=C

# Check dependencies
command -v mpv >/dev/null || {
  echo "mpv required"; >>/tmp/pal.log
  exit 1;
}
command -v choose >/dev/null || {
  echo "choose required"; >>/tmp/pal.log
  exit 1;
}
command -v terminal-notifier >/dev/null || {
  echo "terminal-notifier required"; >>/tmp/pal.log
  exit 1;
}

notification() {
  local message="$1"
  message="${message:0:50}"
  terminal-notifier -message "$message" >/dev/null 2>&1
}

playlists() {
  local music_dir="$1"
  [ -d "$music_dir" ] || {
    echo "Music directory not found"; >>/tmp/pal.log
    notification "Error: Music directory not found"
    exit 1;
  }
  find "$music_dir" -mindepth 1 -type d -exec basename {} \; | sort -f
  echo "Exit"
}

songs() {
  local playlist_dir="$1"
  [ -d "$playlist_dir" ] || {
    echo "Playlist not found"; >>/tmp/pal.log
    notification "Error: Playlist not found"
    exit 1;
  }
  echo "Play All"
  find "$playlist_dir" -maxdepth 1 -type f -iname "*.m4a" -exec basename {} \; | sort -f
}

main() {
  local music_dir="${1:-$HOME/Music}"
  local color="-b f6b8d0"

  local playlist_count=$(playlists "$music_dir" | wc -l | awk '{print $1 + 1}')
  local playlist=$(playlists "$music_dir" | choose "$color" -w 24 -n "$playlist_count")
  [ -z "$playlist" ] || [ "$playlist" = "Exit" ] && { notification "Exiting";
  exit 0; }

  local playlist_path="$music_dir/$playlist"

  if ! songs "$playlist_path" >/dev/null 2>&1; then
    notification "No songs in $playlist"
    exit 1
  fi

  local song_count=$(songs "$playlist_path" | wc -l | awk '{print $1 + 1}')
  local choice=$(songs "$playlist_path" | choose "$color" -w 36 -n "$song_count")
  [ -z "$choice" ] && { notification "No song selected";
  exit 1; }

  if [ "$choice" = "Play All" ]; then
    notification "Playing all songs in $playlist"
    mpv --no-video --shuffle "$playlist_path"/*.m4a --loop-playlist >/dev/null 2>&1
  else
    local song_path="$playlist_path/$choice"
    notification "Playing $choice"
    mpv --no-video "$song_path" --loop >/dev/null 2>&1
  fi
}

pkill -f mpv || main "$@"
